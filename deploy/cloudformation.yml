AWSTemplateFormatVersion: "2010-09-09"
Description: Ethos Academy — EC2 with Docker Compose

Parameters:
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: SSH key pair for EC2 access

  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues: [t3.small, t3.medium, t3.large]

  MyIP:
    Type: String
    Description: Your IP for SSH access (e.g. 203.0.113.0/32)
    AllowedPattern: "\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}/\\d{1,2}"

  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/canonical/ubuntu/server/24.04/stable/current/amd64/hvm/ebs-gp3/ami-id
    Description: Latest Ubuntu 24.04 AMI (auto-resolved via SSM)

Resources:
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Ethos Academy server
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref MyIP
          Description: SSH from my IP
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP (Caddy redirects to HTTPS)
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS
      Tags:
        - Key: Name
          Value: ethos-academy-sg

  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: ethos-academy-eip

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyPairName
      ImageId: !Ref LatestAmiId
      SecurityGroupIds:
        - !GetAtt SecurityGroup.GroupId
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 30
            VolumeType: gp3
      Tags:
        - Key: Name
          Value: ethos-academy
      UserData:
        Fn::Base64: |
          #!/bin/bash
          set -euo pipefail
          exec > /var/log/user-data.log 2>&1

          # Install Docker
          apt-get update
          apt-get install -y ca-certificates curl git
          install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          chmod a+r /etc/apt/keyrings/docker.asc
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" > /etc/apt/sources.list.d/docker.list
          apt-get update
          apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
          usermod -aG docker ubuntu

          # Clone repo
          sudo -u ubuntu git clone https://github.com/allierays/ethos.git /home/ubuntu/ethos

          # Nightly reflection cron (2 AM UTC)
          sudo -u ubuntu bash -c '(crontab -l 2>/dev/null; echo "0 2 * * * cd /home/ubuntu/ethos && docker compose -f docker-compose.prod.yml exec -T app python -m scripts.nightly_reflection >> /var/log/ethos-nightly.log 2>&1") | crontab -'

          # Signal that setup is complete
          echo "UserData complete" > /home/ubuntu/setup-done

  EIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt ElasticIP.AllocationId
      InstanceId: !Ref EC2Instance

Outputs:
  PublicIP:
    Description: Elastic IP — use this for all 3 GoDaddy A records
    Value: !Ref ElasticIP

  SSHCommand:
    Description: SSH into the server
    Value: !Sub "ssh -i ${KeyPairName}.pem ubuntu@${ElasticIP}"

  DNSInstructions:
    Description: Create these A records in GoDaddy (TTL 600)
    Value: !Sub |
      A record: @   → ${ElasticIP}
      A record: api → ${ElasticIP}
      A record: mcp → ${ElasticIP}

  NextSteps:
    Description: After stack creation completes
    Value: !Sub |
      1. SSH in: ssh -i ${KeyPairName}.pem ubuntu@${ElasticIP}
      2. Wait for setup: cat /home/ubuntu/setup-done
      3. Create .env: cd ~/ethos && cp .env.example .env && nano .env
      4. Launch: docker compose -f docker-compose.prod.yml up -d --build
      5. Seed graph: docker compose -f docker-compose.prod.yml exec app python -m scripts.seed_graph
      6. Add DNS records in GoDaddy, then Caddy auto-provisions SSL
